// index.html
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>瞑想タイマー</title>
    <style>
      body {
        background-color: black;
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        height: 100vh;
        user-select: none;
      }

      .timer-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex-grow: 1;
      }

      .timer-display {
        font-size: 5rem;
        text-align: center;
        margin: 20px 0;
      }

      .time-circle {
        border: 3px solid #ff9500;
        border-radius: 50%;
        width: 300px;
        height: 300px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .time-picker {
        display: flex;
        justify-content: center;
        background-color: #1c1c1e;
        border-radius: 12px;
        padding: 10px;
        margin: 20px;
        width: 80%;
        max-width: 400px;
      }

      .picker-column {
        flex: 1;
        text-align: center;
        position: relative;
        height: 120px;
        overflow: hidden;
      }

      .picker-label {
        font-size: 0.8rem;
        opacity: 0.6;
        text-align: center;
        margin-top: 5px;
      }

      .picker-items {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 0;
        margin: 0;
      }

      .picker-item {
        list-style: none;
        padding: 10px 0;
        font-size: 1.2rem;
        opacity: 0.3;
        transition: all 0.2s;
      }

      .picker-item.selected {
        font-size: 1.5rem;
        opacity: 1;
      }

      .button-container {
        display: flex;
        justify-content: space-between;
        width: 100%;
        padding: 20px;
        box-sizing: border-box;
      }

      .button {
        background-color: #1c1c1e;
        color: white;
        border: none;
        border-radius: 50%;
        width: 80px;
        height: 80px;
        font-size: 1rem;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .start-button {
        background-color: #215a35;
      }

      .pause-button {
        background-color: #7d5300;
      }

      .hidden {
        display: none;
      }

      /* アニメーション */
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .pulse {
        animation: pulse 1s infinite;
      }
    </style>
  </head>
  <body>
    <div class="timer-container">
      <!-- タイマー設定画面 -->
      <div id="timerSetup" class="time-picker">
        <div class="picker-column">
          <ul class="picker-items" id="hourPicker">
            <!-- JavaScript で生成 -->
          </ul>
          <div class="picker-label">時間</div>
        </div>
        <div class="picker-column">
          <ul class="picker-items" id="minutePicker">
            <!-- JavaScript で生成 -->
          </ul>
          <div class="picker-label">分</div>
        </div>
        <div class="picker-column">
          <ul class="picker-items" id="secondPicker">
            <!-- JavaScript で生成 -->
          </ul>
          <div class="picker-label">秒</div>
        </div>
      </div>

      <!-- タイマー表示画面 -->
      <div id="timerDisplay" class="hidden">
        <div class="time-circle">
          <div class="timer-display" id="timeDisplay">00:00</div>
        </div>
      </div>
    </div>

    <div class="button-container">
      <button id="cancelButton" class="button">キャンセル</button>
      <button id="startButton" class="button start-button">開始</button>
      <button id="pauseButton" class="button pause-button hidden">
        一時停止
      </button>
    </div>

    <audio id="alarmSound" src="alarm.mp3" preload="auto"></audio>

    <script>
      // 要素の取得
      const timerSetup = document.getElementById("timerSetup");
      const timerDisplay = document.getElementById("timerDisplay");
      const timeDisplay = document.getElementById("timeDisplay");
      const hourPicker = document.getElementById("hourPicker");
      const minutePicker = document.getElementById("minutePicker");
      const secondPicker = document.getElementById("secondPicker");
      const startButton = document.getElementById("startButton");
      const pauseButton = document.getElementById("pauseButton");
      const cancelButton = document.getElementById("cancelButton");
      const alarmSound = document.getElementById("alarmSound");

      // ピッカー要素の生成
      function generatePickerItems(element, max, defaultSelected = 0) {
        for (let i = 0; i <= max; i++) {
          const item = document.createElement("li");
          item.classList.add("picker-item");
          item.textContent = i.toString().padStart(2, "0");
          item.dataset.value = i;
          if (i === defaultSelected) {
            item.classList.add("selected");
          }
          item.addEventListener("click", () => selectPickerItem(element, item));
          element.appendChild(item);
        }
      }

      // ピッカーアイテムの選択
      function selectPickerItem(picker, item) {
        // 以前の選択をクリア
        picker.querySelectorAll(".picker-item").forEach((el) => {
          el.classList.remove("selected");
        });

        // 新しい選択
        item.classList.add("selected");

        // スクロール位置の調整
        const itemHeight = item.offsetHeight;
        const containerHeight = picker.offsetHeight;
        const offset = containerHeight / 2 - itemHeight / 2;

        picker.scrollTop = item.offsetTop - offset;
      }

      // ピッカーの初期化
      generatePickerItems(hourPicker, 23);
      generatePickerItems(minutePicker, 59, 15); // デフォルトで15分を選択
      generatePickerItems(secondPicker, 59);

      // タイマー変数
      let timerInterval;
      let remainingTime = 0;
      let endTime = 0;
      let isPaused = false;

      // タイマーの開始
      function startTimer() {
        // 選択された時間を取得
        const hours = parseInt(
          hourPicker.querySelector(".selected").dataset.value
        );
        const minutes = parseInt(
          minutePicker.querySelector(".selected").dataset.value
        );
        const seconds = parseInt(
          secondPicker.querySelector(".selected").dataset.value
        );

        // 秒に変換
        remainingTime = hours * 3600 + minutes * 60 + seconds;

        if (remainingTime <= 0) {
          return; // 時間が0の場合は何もしない
        }

        // UI切り替え
        timerSetup.classList.add("hidden");
        timerDisplay.classList.remove("hidden");
        startButton.classList.add("hidden");
        pauseButton.classList.remove("hidden");

        // 終了時間を計算
        endTime = Date.now() + remainingTime * 1000;

        // タイマー開始
        updateTimerDisplay();
        timerInterval = setInterval(updateTimerDisplay, 500);
      }

      // タイマーの一時停止/再開
      function togglePause() {
        if (isPaused) {
          // 再開
          isPaused = false;
          endTime = Date.now() + remainingTime * 1000;
          timerInterval = setInterval(updateTimerDisplay, 500);
          pauseButton.textContent = "一時停止";
          timeDisplay.classList.remove("pulse");
        } else {
          // 一時停止
          isPaused = true;
          clearInterval(timerInterval);
          pauseButton.textContent = "再開";
          timeDisplay.classList.add("pulse");
        }
      }

      // タイマーのキャンセル
      function cancelTimer() {
        clearInterval(timerInterval);
        timerSetup.classList.remove("hidden");
        timerDisplay.classList.add("hidden");
        startButton.classList.remove("hidden");
        pauseButton.classList.add("hidden");
        pauseButton.textContent = "一時停止";
        timeDisplay.classList.remove("pulse");
        isPaused = false;
      }

      // タイマー表示の更新
      function updateTimerDisplay() {
        if (isPaused) {
          return;
        }

        const now = Date.now();
        remainingTime = Math.max(0, Math.round((endTime - now) / 1000));

        if (remainingTime <= 0) {
          clearInterval(timerInterval);
          timeDisplay.textContent = "00:00";
          playAlarm();

          // タイマー完了後にUIをリセット
          setTimeout(() => {
            cancelTimer();
          }, 3000);

          return;
        }

        const hours = Math.floor(remainingTime / 3600);
        const minutes = Math.floor((remainingTime % 3600) / 60);
        const seconds = remainingTime % 60;

        if (hours > 0) {
          timeDisplay.textContent = `${hours
            .toString()
            .padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds
            .toString()
            .padStart(2, "0")}`;
        } else {
          timeDisplay.textContent = `${minutes
            .toString()
            .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
        }
      }

      // アラーム音の再生
      function playAlarm() {
        // アラームは一度だけ再生（リピートしない）
        alarmSound.play();
      }

      // イベントリスナー
      startButton.addEventListener("click", startTimer);
      pauseButton.addEventListener("click", togglePause);
      cancelButton.addEventListener("click", cancelTimer);

      // タッチ操作のサポート
      let startY = 0;
      let currentPicker = null;

      function handleTouchStart(e) {
        const target = e.target.closest(".picker-column");
        if (!target) return;

        startY = e.touches[0].clientY;
        currentPicker = target.querySelector(".picker-items");
        e.preventDefault();
      }

      function handleTouchMove(e) {
        if (!currentPicker) return;

        const deltaY = e.touches[0].clientY - startY;
        const items = currentPicker.querySelectorAll(".picker-item");
        const itemHeight = items[0].offsetHeight;

        if (Math.abs(deltaY) > itemHeight / 2) {
          const direction = deltaY > 0 ? -1 : 1;
          const selectedItem = currentPicker.querySelector(".selected");
          const currentIndex = Array.from(items).indexOf(selectedItem);
          const newIndex = Math.max(
            0,
            Math.min(items.length - 1, currentIndex + direction)
          );

          if (newIndex !== currentIndex) {
            selectPickerItem(currentPicker, items[newIndex]);
            startY = e.touches[0].clientY;
          }
        }

        e.preventDefault();
      }

      function handleTouchEnd() {
        currentPicker = null;
      }

      document.addEventListener("touchstart", handleTouchStart, {
        passive: false,
      });
      document.addEventListener("touchmove", handleTouchMove, {
        passive: false,
      });
      document.addEventListener("touchend", handleTouchEnd);
    </script>
  </body>
</html>
