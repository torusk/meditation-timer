<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meditation Timer</title>
    <link rel="manifest" href="/manifest.json" />
    <style>
      /* 基本設定 */
      :root {
        --button-size: 80vmin; /* ボタン基本サイズ（縦横同じ） */
        --max-button-size: 500px; /* 最大サイズ制限 */
        --active-color: #43a047; /* 動作中の色 */
        --alarm-color: #e53935; /* アラーム色 */
      }

      body {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background-color: #f0f0f0;
        padding: 20px;
      }

      /* タイマーボタンの基本スタイル */
      .timer-button {
        width: var(--button-size);
        height: var(--button-size);
        max-width: var(--max-button-size);
        max-height: var(--max-button-size);
        border-radius: 50%;
        border: none;
        background: linear-gradient(135deg, #c0c0c0, #e0e0e0, #c0c0c0);
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.2),
          inset 0 0 10px rgba(255, 255, 255, 0.5), 0 10px 0 #d4d4d4;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        position: relative;
      }

      /* ホバー時の立体効果 */
      .timer-button:hover {
        transform: translateY(2px);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.15),
          inset 0 0 8px rgba(255, 255, 255, 0.4), 0 5px 0 #d4d4d4;
      }

      /* タイマー動作中のスタイル */
      .timer-button.active {
        background: linear-gradient(
          135deg,
          var(--active-color),
          #66bb6a,
          var(--active-color)
        );
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.2),
          inset 0 0 10px rgba(255, 255, 255, 0.5), 0 5px 0 #388e3c;
      }

      /* アラーム発報時のスタイル */
      .timer-button.alarm {
        background: linear-gradient(
          135deg,
          var(--alarm-color),
          #ef5350,
          var(--alarm-color)
        );
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.3),
          inset 0 0 10px rgba(255, 255, 255, 0.3), 0 5px 0 #c62828;
        animation: pulse 1s infinite;
      }

      /* アラーム時のパルスアニメーション */
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(0.98);
        }
        100% {
          transform: scale(1);
        }
      }

      /* モバイル端末向け調整 */
      @media (max-width: 600px) {
        :root {
          --button-size: 70vmin; /* モバイルでやや大きく */
        }
      }
    </style>
  </head>
  <body>
    <!-- メインのタイマーボタン -->
    <button class="timer-button"></button>

    <script>
      // 要素の取得（変更なし）
      const button = document.querySelector(".timer-button");
      const audio = new Audio("alarm.mp3");
      let timeoutId;
      let wakeLock = null;

      // Service Workerの強化（バックグラウンド同期追加）
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/sw.js").then((registration) => {
          console.log("Service Worker登録完了");

          // バックグラウンド同期の登録
          registration.sync
            .register("timer-sync")
            .then(() => console.log("バックグラウンド同期登録"))
            .catch((err) => console.error("同期登録失敗:", err));
        });
      }

      // Wake Lockの持続的監視（追加）
      let wakeLockReleased = false;
      async function acquireWakeLock() {
        try {
          wakeLock = await navigator.wakeLock.request("screen");
          wakeLock.addEventListener("release", () => {
            wakeLockReleased = true;
            console.log("Wake Lockが解除されました");
          });
          console.log("画面スリープ防止を開始");
        } catch (err) {
          console.error("Wake Lock取得失敗:", err);
        }
      }

      // バックグラウンドチェック用のブロードキャストチャネル（追加）
      const channel = new BroadcastChannel("timer-channel");
      channel.onmessage = (event) => {
        if (event.data === "check-timer") {
          const endTime = localStorage.getItem("timerEnd");
          if (endTime && Date.now() >= endTime) {
            handleTimerEnd();
          }
        }
      };

      // タイマー終了処理（改善版）
      function handleTimerEnd() {
        // 状態クリア処理
        const clearStates = () => {
          button.classList.remove("active", "alarm");
          localStorage.removeItem("timerEnd");
          if (wakeLock && !wakeLockReleased) {
            wakeLock.release();
            wakeLock = null;
          }
        };

        // アラーム音の再生保証
        const playAlarm = () => {
          audio.play().catch((err) => {
            console.error("音声再生失敗:", err);
            setTimeout(playAlarm, 1000);
          });
        };

        button.classList.remove("active");
        button.classList.add("alarm");
        playAlarm();

        // アラーム停止処理
        const stopAlarm = () => {
          audio.pause();
          audio.currentTime = 0;
          clearStates();
        };

        // タップによる停止
        button.addEventListener("click", stopAlarm, { once: true });

        // 自動停止（1分後）
        setTimeout(clearStates, 60000);
      }

      // 残り時間計算の強化（追加）
      function calculateRemaining() {
        const endTime = localStorage.getItem("timerEnd");
        if (!endTime) return 0;

        const remaining = endTime - Date.now();
        return remaining > 0 ? remaining : 0;
      }

      // ページ可視性監視（追加）
      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") {
          const remaining = calculateRemaining();
          if (remaining > 0) {
            timeoutId = setTimeout(handleTimerEnd, remaining);
          }
        }
      });

      // ボタンクリックイベント（変更なし）
      button.addEventListener("click", async () => {
        if (button.classList.contains("active")) return;

        const duration = 15 * 60 * 1000;
        localStorage.setItem("timerEnd", Date.now() + duration);
        await acquireWakeLock();
        button.classList.add("active");
        timeoutId = setTimeout(handleTimerEnd, duration);
      });

      // 初期化処理（強化版）
      window.addEventListener("load", () => {
        const remaining = calculateRemaining();
        if (remaining > 0) {
          button.classList.add("active");
          timeoutId = setTimeout(handleTimerEnd, remaining);
          acquireWakeLock();
        }

        // 音声初期化（iOS対応）
        const initAudio = () => {
          audio.play().then(() => audio.pause());
          document.removeEventListener("click", initAudio);
        };
        document.addEventListener("click", initAudio, { once: true });
      });
    </script>
  </body>
</html>
